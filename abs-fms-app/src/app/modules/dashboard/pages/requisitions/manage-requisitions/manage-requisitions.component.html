<!-- Create Requisitions Page -->
<div class="create-requisitions-container">
  <!-- Header with Action Buttons -->
  <div class="header-section">
    <div class="title-section">
      <h2>Manage Requisitions</h2>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="content-section">
    <!-- Header Section -->
    <div class="subheader">
      <!-- Search Bar  -->
      <div class="search-section">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Requisitions</mat-label>
          <input matInput (keyup)="applyFilter($event)"
            placeholder="Search by code, payee, narrative, or invoice number">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <!-- Requisitions Table -->
    <div class="table-container">
      <mat-table [dataSource]="dataSource" matSort class="requisitions-table mat-elevation-z8">

        <!-- Code Column -->
        <ng-container matColumnDef="code">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Code</mat-header-cell>
          <mat-cell *matCellDef="let element">{{element.code}}</mat-cell>
        </ng-container>

        <!-- Payee Column -->
        <ng-container matColumnDef="payee">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Payee</mat-header-cell>
          <mat-cell *matCellDef="let element">{{element.payee}}</mat-cell>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Amount</mat-header-cell>
          <mat-cell *matCellDef="let element">
            <span class="amount-cell">{{formatCurrency(element.amount, element.currency)}}</span>
          </mat-cell>
        </ng-container>

        <!-- Invoice Number Column -->
        <ng-container matColumnDef="invoiceNo">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Invoice No</mat-header-cell>
          <mat-cell *matCellDef="let element">{{element.invoiceNo}}</mat-cell>
        </ng-container>

        <!-- Narrative Column -->
        <ng-container matColumnDef="narrative">
          <mat-header-cell *matHeaderCellDef>Narrative</mat-header-cell>
          <mat-cell *matCellDef="let element">
            <span class="narrative-cell" [title]="element.narrative">
              {{element.narrative.length > 50 ? (element.narrative | slice:0:50) + '...' : element.narrative}}
            </span>
          </mat-cell>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
          <mat-cell *matCellDef="let element">
            <span class="status-badge" [ngClass]="'status-' + element.status.toLowerCase()">
              {{element.status}}
            </span>
          </mat-cell>
        </ng-container>

        <!-- Actions Column -->

        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef style="min-width: 220px;">Actions</mat-header-cell>
          <mat-cell *matCellDef="let element" style="min-width: 220px;">
            <div class="table-action-buttons">
              <button mat-button class="btn" style="background-color:#a5f8a7;" (click)="authorize(element)">Authorize
              </button>

              <button mat-button class="btn" style="background-color:#f98f88;" (click)="reject(element)">Reject
              </button>

              <button mat-icon-button [matMenuTriggerFor]="actionMenu"
                aria-label="Actions"><mat-icon>more_horiz</mat-icon></button>


              <!-- Dropdown for edit/view/delete -->
              <mat-menu #actionMenu="matMenu">
                <button mat-menu-item (click)="viewDetails(element)">
                  <mat-icon>visibility</mat-icon>
                  <span>View details</span>
                </button>
                <button mat-menu-item (click)="editRequisition(element)">
                  <mat-icon>edit</mat-icon>
                  <span>Edit</span>
                </button>
                <button mat-menu-item (click)="deleteRequisition(element)">
                  <mat-icon>delete</mat-icon>
                  <span>Delete</span>
                </button>
              </mat-menu>


            </div>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>

        <!-- No Data Row -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            <div class="no-data-message">
              <mat-icon>inbox</mat-icon>
              <p>No requisitions found</p>
              <p class="no-data-subtitle">Create your first requisition using the button above</p>
            </div>
          </td>
        </tr>
      </mat-table>

      <!-- Paginator -->
      <mat-paginator [pageSizeOptions]="[5, 10, 20, 50]" [pageSize]="10" showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</div>


<!-- View Details Modal -->
<div class="modal-overlay" *ngIf="showViewDetailsModal" (click)="closeViewDetailsModal()">
  <div class="modal-content view-details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Requisition Details</h3>
      <button mat-icon-button (click)="closeViewDetailsModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- View Mode -->
    <div class="modal-body" *ngIf="selectedRequisition">
      <div class="details-grid">
        <div class="detail-item">
          <label>Code:</label>
          <span class="detail-value">{{selectedRequisition.code}}</span>
        </div>

        <div class="detail-item">
          <label>Status:</label>
          <span class="status-badge" [ngClass]="'status-' + selectedRequisition.status.toLowerCase()">
            {{selectedRequisition.status}}
          </span>
        </div>

        <div class="detail-item">
          <label>Payee:</label>
          <span class="detail-value">{{selectedRequisition.payee}}</span>
        </div>

        <div class="detail-item">
          <label>Cheque Payee:</label>
          <span class="detail-value">{{selectedRequisition.chequePayee}}</span>
        </div>

        <div class="detail-item">
          <label>Bank Branch:</label>
          <span class="detail-value">{{selectedRequisition.payeeBankBranch}}</span>
        </div>

        <div class="detail-item">
          <label>Account Number:</label>
          <span class="detail-value">{{selectedRequisition.payeeAccountNo}}</span>
        </div>

        <div class="detail-item">
          <label>Amount:</label>
          <span class="detail-value amount-highlight">{{formatCurrency(selectedRequisition.amount,
            selectedRequisition.currency)}}</span>
        </div>

        <div class="detail-item">
          <label>Currency:</label>
          <span class="detail-value">{{selectedRequisition.currency}}</span>
        </div>

        <div class="detail-item">
          <label>Invoice Number:</label>
          <span class="detail-value">{{selectedRequisition.invoiceNo}}</span>
        </div>

        <div class="detail-item">
          <label>Invoice Date:</label>
          <span class="detail-value">{{selectedRequisition.invoiceDate | date:'mediumDate'}}</span>
        </div>

        <div class="detail-item">
          <label>Bank Account:</label>
          <span class="detail-value">{{selectedRequisition.bankAccount}}</span>
        </div>

        <div class="detail-item">
          <label>Payment Option:</label>
          <span class="detail-value">{{selectedRequisition.paymentOption}}</span>
        </div>

        <div class="detail-item full-width">
          <label>Narrative:</label>
          <span class="detail-value">{{selectedRequisition.narrative}}</span>
        </div>

        <div class="detail-item">
          <label>Created Date:</label>
          <span class="detail-value">{{selectedRequisition.createdDate | date:'medium'}}</span>
        </div>

        <div class="detail-item">
          <label>Created By:</label>
          <span class="detail-value">{{selectedRequisition.createdBy}}</span>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
     <div class="modal-footer">
      <!-- View Mode Buttons -->
  

      <!-- Edit Mode Buttons -->
      <ng-container>
        <button mat-button (click)="closeViewDetailsModal()">Cancel</button>
        
      </ng-container>
    </div> 
  </div>
</div>

<!-- Edit Mode -->
<div class="modal-overlay" *ngIf="showEditModal">
  <div class="modal-content edit-modal" (click)="$event.stopPropagation()">
     <div class="modal-header">
      <h3>Edit Requisition</h3>
      <button mat-icon-button (click)="closeEditModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form class="modal-body edit-form" [formGroup]="editForm">
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Payee</mat-label>
          <input matInput formControlName="payee" placeholder="Enter payee name">
          <mat-error *ngIf="editForm.get('payee')?.invalid && editForm.get('payee')?.touched">
            Payee is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Code</mat-label>
          <input matInput formControlName="code" placeholder="Enter requisition code">
          <mat-error *ngIf="editForm.get('code')?.invalid && editForm.get('code')?.touched">
            Code is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Cheque Payee</mat-label>
          <input matInput formControlName="chequePayee" placeholder="Enter cheque payee">
          <mat-error *ngIf="editForm.get('chequePayee')?.invalid && editForm.get('chequePayee')?.touched">
            Cheque payee is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Payee Bank Branch</mat-label>
          <mat-select formControlName="payeeBankBranch">
            <mat-option value="">-- Select Bank Branch --</mat-option>
            <mat-option *ngFor="let branch of bankBranches" [value]="branch.value">
              {{branch.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Account Number</mat-label>
          <input matInput formControlName="payeeAccountNo" placeholder="Enter account number">
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Amount</mat-label>
          <input matInput type="number" formControlName="amount" placeholder="0.00" min="0" step="0.01">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Currency</mat-label>
          <mat-select formControlName="currency">
            <mat-option *ngFor="let currency of currencies" [value]="currency.value">
              {{ currency.symbol }} - {{ currency.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Invoice Number</mat-label>
          <input matInput formControlName="invoiceNo" placeholder="Enter invoice number">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Invoice Date</mat-label>
          <input matInput [matDatepicker]="editInvoicePicker" formControlName="invoiceDate" readonly>
          <mat-datepicker-toggle matSuffix [for]="editInvoicePicker"></mat-datepicker-toggle>
          <mat-datepicker #editInvoicePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Bank Account</mat-label>
          <mat-select formControlName="bankAccount">
            <mat-option value="">-- Select Bank Account --</mat-option>
            <mat-option *ngFor="let account of bankAccounts" [value]="account.value">
              {{ account.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Type</mat-label>
          <mat-select formControlName="type">
            <mat-option value="">-- Select Payee Type --</mat-option>
            <mat-option *ngFor="let type of payeeTypes" [value]="type.value">
              {{ type.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Payment Option</mat-label>
          <mat-select formControlName="paymentOption">
            <mat-option value="">-- Select Payment Method --</mat-option>
            <mat-option *ngFor="let option of paymentOptions" [value]="option.value">
              {{ option.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Narrative</mat-label>
          <textarea matInput formControlName="narrative" rows="3" placeholder="Enter narrative"></textarea>
        </mat-form-field>
      </div>

    </form>

    <div class="modal-footer">
      <button mat-button (click)="cancelEdit()">Clear</button>
      <button mat-raised-button color="primary" (click)="updateRequisition()">Update</button>
    </div>
  </div>
</div>